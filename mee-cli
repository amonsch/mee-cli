#!/usr/bin/env python

""" Validate SQL """

from pygments.lexers.sql import SqlLexer
from pygments.styles import get_style_by_name

from prompt_toolkit.lexers import PygmentsLexer
from prompt_toolkit.shortcuts import PromptSession
from prompt_toolkit.history import FileHistory
from prompt_toolkit.styles import style_from_pygments_cls
from prompt_toolkit.completion import WordCompleter
from prompt_toolkit.validation import Validator, ValidationError

import sql_mojo_parser as parser


KEYWORDS = [
    "SELECT", "FROM", "WHERE", "GROUP", "ORDER BY", "LIMIT",  # ... etc.
]


def validate(text):
    text = text.strip().rstrip(";")
    if not text:
        return

    try:
        return parser.yacc.parse(text)
    except SyntaxError as exc:
        raise ValidationError(message="Your SQL is WRONG!!")


def main():
    completer = WordCompleter(KEYWORDS, ignore_case=True)
    style = get_style_by_name("monokai")
    history = FileHistory(".mee_history")
    session = PromptSession(
        " >>> ",
        history=history,
        lexer=PygmentsLexer(SqlLexer),
        style=style_from_pygments_cls(style),
        completer=completer,
        complete_while_typing=False,
        validator=Validator.from_callable(validate),
        validate_while_typing=False,
    )
    while True:
        try:
            session.prompt()
            print(f"Your statement seems legit!")
        except EOFError:
            break


if __name__ == "__main__":
    main()
